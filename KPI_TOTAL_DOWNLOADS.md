# KPI Specification: Total Estimated Downloads

## 1. Overview
The **Total Estimated Downloads** KPI is a primary growth metric displayed in the CEO Cockpit. 
Unlike "Actual Downloads" (which requires direct integration with Apple App Store Connect and Google Play Console), this metric is derived from **User Intent** tracking via our unique campaign links.

### The Core Concept
Since we cannot track users once they leave our landing page/redirector to enter the App Stores (without complex SDKs), we use a **Funnel-Based Estimation** model:

$$ \text{Estimated Downloads} = (\text{Total Unique Clicks} \times \text{Conversion Rate}) + \text{Manual Organic Baseline} $$

---

## 2. Tracking Methodology

### A. The "Unique Link" Strategy
Every marketing touchpoint must have a unique tracking link generated by the Rappn Campaign Tracker.

*   **Website Button:** `rappn.ch/r/web-home-hero`
*   **Bern Flyer QR:** `rappn.ch/r/flyer-bern-2025`
*   **Instagram Bio:** `rappn.ch/r/social-insta-bio`

### B. The User Journey
1.  **User Action:** User scans a QR code or clicks a link.
2.  **System Action:** Request hits our backend (`/r/:placement_id`).
3.  **Logging:** Backend records:
    *   `placement_id` (Source)
    *   `timestamp`
    *   `user_agent` (Device Type: iOS/Android)
    *   `ip_hash` (For unique visitor de-duplication)
4.  **Redirect:** User is immediately redirected to the appropriate App Store.

---

## 3. Technical Implementation

### Data Structure (Google Sheets / Database)

We utilize the existing `Clicks` sheet but require specific aggregation logic.

**`Clicks` Table Schema:**
| Column | Field | Description |
| :--- | :--- | :--- |
| A | `id` | UUID of the click event |
| B | `timestamp` | ISO 8601 Date |
| C | `placement_id` | Links to `Placements` table |
| D | `campaign_id` | Links to `Campaigns` table |
| E | `device_os` | 'iOS' or 'Android' (parsed from User Agent) |

### Configuration Constants
These should be stored in a config file or environment variables to allow tuning.

```typescript
const CONFIG = {
  // Industry standard conversion rate from App Store Page View -> Install
  ESTIMATED_CONVERSION_RATE: 0.25, // 25%
  
  // Optional: Baseline for organic traffic not coming through links
  ORGANIC_BASELINE_DAILY: 15 
};
```

### Backend Logic (Pseudo-Code)

**1. Calculate Attributed Downloads:**
```typescript
function getAttributedDownloads(startDate, endDate) {
  const clicks = db.fetchClicks(startDate, endDate);
  
  // Group by Source
  const sourceBreakdown = clicks.reduce((acc, click) => {
    const source = click.source_name; // e.g., "Bern Flyer"
    acc[source] = (acc[source] || 0) + 1;
    return acc;
  }, {});

  // Apply Conversion Rate
  const estimatedDownloads = {};
  for (const [source, count] of Object.entries(sourceBreakdown)) {
    estimatedDownloads[source] = Math.round(count * CONFIG.ESTIMATED_CONVERSION_RATE);
  }

  return estimatedDownloads;
}
```

**2. Reconciling with Actuals (Calibration):**
To make this KPI accurate, we need a "Calibration Factor".
*   Once a month, the Admin inputs the *actual* download number from App Store Connect.
*   The system compares `Actual` vs `Estimated`.
*   If `Estimated` is consistently lower, the system suggests increasing the `ESTIMATED_CONVERSION_RATE`.

---

## 4. API Response Structure

**Endpoint:** `GET /api/v1/analytics/growth-trend`

The frontend expects data pre-calculated with the estimation logic.

```json
{
  "summary": {
    "total_estimated": 12450,
    "growth_rate": 12.5,
    "target_progress": 25
  },
  "breakdown": [
    {
      "source": "Bern Flyer",
      "clicks": 1000,
      "estimated_downloads": 250, // 1000 * 0.25
      "conversion_rate_used": 0.25
    },
    {
      "source": "Instagram Bio",
      "clicks": 500,
      "estimated_downloads": 125,
      "conversion_rate_used": 0.25
    }
  ],
  "trend": [
    {
      "date": "2025-12-01",
      "clicks": 150,
      "estimated_downloads": 38
    }
    // ... daily data
  ]
}
```

## 5. Developer Checklist

1.  [ ] **Link Generator:** Ensure the "Create Campaign" wizard generates unique shortlinks (`/r/xyz`).
2.  [ ] **Click Logger:** Ensure the redirect endpoint (`/r/:id`) logs to the `Clicks` sheet *before* redirecting.
3.  [ ] **User Agent Parsing:** Extract OS (iOS/Android) from headers to allow platform segmentation.
4.  [ ] **Dashboard Update:** Update the "Total Downloads" card to fetch from the new aggregation logic, applying the 25% multiplier.
5.  [ ] **Calibration UI:** (Future) Add a simple input field in Settings to enter "Actual App Store Data" to auto-tune the conversion rate.
